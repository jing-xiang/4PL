shipments_list = [{ "Job_No": "CFA0623223", "Master_BL_No": "CFA0623223", "Container_Mode": "FCL", "Place_Of_Loading_ID": "EGPSD", "Place_Of_Loading_Name": "PORT SAID", "Place_Of_Discharge_ID": "MYPKG", "Place_Of_Discharge_Name": "PORT KLANG", "Vessel_Name": "CMA CGM TANYA", "Voyage_No": "0BEFWE1MA", "ETD_Date": "2023-10-16T00:00:00", "ETA_Date": "2023-12-31T00:00:00", "Carrier_Matchcode": "CMACGM", "Carrier_Name": "CMA CGM", "Carrier_Contract_No": "", "Carrier_Booking_Reference_No": "", "Inco_Terms": "", "Controlling_Customer_Name": "Mondelez Malaysia Sales Sdn Bhd", "Shipper_Name": "", "Consignee_Name": "", "Total_No_Of_Pieces": 0, "Package_Type": "", "Total_No_Of_Volume_Weight_MTQ": 0.0, "Total_No_Of_Gross_Weight_KGM": 0.0, "Description": "Chocolate and other preparatio", "Shipment_Note": "12-7-2023_2-40-21.pdf", "Container_List": [{ "Id": "", "Shipment_Job_No": "CFA0623223", "Container_No": "CXRU1122457", "Container_Type": "40' HC Container REEFER", "Seal_No_1": "", "Seal_No_2": "" }] }, { "Job_No": "EGLV235301061137", "Master_BL_No": "EGLV235301061137", "Container_Mode": "FCL", "Place_Of_Loading_ID": "VNSGN", "Place_Of_Loading_Name": "HO CHI MINH", "Place_Of_Discharge_ID": "MYPKG", "Place_Of_Discharge_Name": "PORT KLANG", "Vessel_Name": "GREEN CELESTE", "Voyage_No": "0402-076S", "ETD_Date": "2023-10-16T00:00:00", "ETA_Date": "2023-10-16T00:00:00", "Carrier_Matchcode": "EVESHI", "Carrier_Name": "Evergreen", "Carrier_Contract_No": "", "Carrier_Booking_Reference_No": "", "Inco_Terms": "", "Controlling_Customer_Name": "Mondelez Malaysia Sales Sdn Bhd", "Shipper_Name": "", "Consignee_Name": "", "Total_No_Of_Pieces": 0, "Package_Type": "", "Total_No_Of_Volume_Weight_MTQ": 231.964, "Total_No_Of_Gross_Weight_KGM": 20530.6, "Description": "", "Shipment_Note": "12-7-2023_2-40-21_1.pdf", "Container_List": [{ "Id": "", "Shipment_Job_No": "EGLV235301061137", "Container_No": "EITU0211727", "Container_Type": "20' Container DRY", "Seal_No_1": "", "Seal_No_2": "" }, { "Id": "", "Shipment_Job_No": "EGLV235301061137", "Container_No": "EMCU1549986", "Container_Type": "40' HC Container DRY", "Seal_No_1": "", "Seal_No_2": "" }, { "Id": "", "Shipment_Job_No": "EGLV235301061137", "Container_No": "TRHU563708", "Container_Type": "40' HC Container DRY", "Seal_No_1": "", "Seal_No_2": "" }, { "Id": "", "Shipment_Job_No": "EGLV235301061137", "Container_No": "TRHU563708", "Container_Type": "40' HC Container DRY", "Seal_No_1": "", "Seal_No_2": "" }] }, { "Job_No": "HLCUSGN2309AOZF8", "Master_BL_No": "HLCUSGN2309AOZF8", "Container_Mode": "FCL", "Place_Of_Loading_ID": "VNSGN", "Place_Of_Loading_Name": "HO CHI MINH", "Place_Of_Discharge_ID": "MYPKG", "Place_Of_Discharge_Name": "PORT KLANG", "Vessel_Name": "CAT LAI EXPRESS", "Voyage_No": "027S", "ETD_Date": "2023-10-09T00:00:00", "ETA_Date": "2023-10-13T00:00:00", "Carrier_Matchcode": "HELWOR", "Carrier_Name": "Hellmann Worldwide Logistics", "Carrier_Contract_No": "", "Carrier_Booking_Reference_No": "", "Inco_Terms": "", "Controlling_Customer_Name": "Mondelez Malaysia Sales Sdn Bhd", "Shipper_Name": "Mondelez Kinh Do Vietnam Joint Stock Company", "Consignee_Name": "Mondelez Malaysia Sales Sdn Bhd", "Total_No_Of_Pieces": 15369, "Package_Type": "CAS", "Total_No_Of_Volume_Weight_MTQ": 406.999, "Total_No_Of_Gross_Weight_KGM": 43138.1, "Description": "Cadbury Cookie\nOreo Wafer Roll\nJacobs Baker Crisps", "Shipment_Note": "12-7-2023_2-40-21_2.pdf", "Container_List": [{ "Id": "", "Shipment_Job_No": "HLCUSGN2309AOZF8", "Container_No": "CXDU1837498", "Container_Type": "40' HC Container DRY", "Seal_No_1": "", "Seal_No_2": "" }, { "Id": "", "Shipment_Job_No": "HLCUSGN2309AOZF8", "Container_No": "FANU3020537", "Container_Type": "40' HC Container DRY", "Seal_No_1": "", "Seal_No_2": "" }, { "Id": "", "Shipment_Job_No": "HLCUSGN2309AOZF8", "Container_No": "FDCU0141586", "Container_Type": "40' HC Container DRY", "Seal_No_1": "", "Seal_No_2": "" }, { "Id": "", "Shipment_Job_No": "HLCUSGN2309AOZF8", "Container_No": "HLBU2602228", "Container_Type": "40' HC Container DRY", "Seal_No_1": "", "Seal_No_2": "" }, { "Id": "", "Shipment_Job_No": "HLCUSGN2309AOZF8", "Container_No": "TLLU5305668", "Container_Type": "40' HC Container DRY", "Seal_No_1": "", "Seal_No_2": "" }, { "Id": "", "Shipment_Job_No": "HLCUSGN2309AOZF8", "Container_No": "TXGU6982027", "Container_Type": "40' HC Container DRY", "Seal_No_1": "", "Seal_No_2": "" }] }, { "Job_No": "SUBD22700800", "Master_BL_No": "SUBD22700800", "Container_Mode": "FCL", "Place_Of_Loading_ID": "IDSUB", "Place_Of_Loading_Name": "SURABAYA", "Place_Of_Discharge_ID": "MYPKG", "Place_Of_Discharge_Name": "PORT KLANG", "Vessel_Name": "APL PUSAN", "Voyage_No": "APUT1012N", "ETD_Date": "2023-01-01T00:00:00", "ETA_Date": "2023-12-31T00:00:00", "Carrier_Matchcode": "OCENET", "Carrier_Name": "ONE", "Carrier_Contract_No": "", "Carrier_Booking_Reference_No": "", "Inco_Terms": "", "Controlling_Customer_Name": "Mondelez Malaysia Sales Sdn Bhd", "Shipper_Name": "", "Consignee_Name": "", "Total_No_Of_Pieces": 0, "Package_Type": "", "Total_No_Of_Volume_Weight_MTQ": 0.0, "Total_No_Of_Gross_Weight_KGM": 0.0, "Description": "", "Shipment_Note": "12-7-2023_2-40-21_3.pdf", "Container_List": [{ "Id": "", "Shipment_Job_No": "SUBD22700800", "Container_No": "FSCU5906419", "Container_Type": "40' HC Container REEFER", "Seal_No_1": "", "Seal_No_2": "" }, { "Id": "", "Shipment_Job_No": "SUBD22700800", "Container_No": "ONEU9113302", "Container_Type": "40' HC Container REEFER", "Seal_No_1": "", "Seal_No_2": "" }, { "Id": "", "Shipment_Job_No": "SUBD22700800", "Container_No": "SEGU9403156", "Container_Type": "40' HC Container REEFER", "Seal_No_1": "", "Seal_No_2": "" }] }, { "Job_No": "OOLU2727887140", "Master_BL_No": "OOLU2727887140", "Container_Mode": "FCL", "Place_Of_Loading_ID": "IDSUB", "Place_Of_Loading_Name": "SURABAYA", "Place_Of_Discharge_ID": "MYPKG", "Place_Of_Discharge_Name": "PORT KLANG", "Vessel_Name": "CMA CGM LISBON", "Voyage_No": "1UE0MN", "ETD_Date": "2023-11-05T00:00:00", "ETA_Date": "2023-11-13T00:00:00", "Carrier_Matchcode": "CMACGM", "Carrier_Name": "CMA CGM", "Carrier_Contract_No": "", "Carrier_Booking_Reference_No": "", "Inco_Terms": "FCA", "Controlling_Customer_Name": "Mondelez Malaysia Sales Sdn Bhd", "Shipper_Name": "", "Consignee_Name": "Mondelez Malaysia Sales Sdn Bhd", "Total_No_Of_Pieces": 0, "Package_Type": "", "Total_No_Of_Volume_Weight_MTQ": 273.69, "Total_No_Of_Gross_Weight_KGM": 52119.83, "Description": "", "Shipment_Note": "12-7-2023_2-40-21_5.pdf", "Container_List": [{ "Id": "", "Shipment_Job_No": "OOLU2727887140", "Container_No": "CONT1", "Container_Type": "40' HC Container DRY", "Seal_No_1": "", "Seal_No_2": "" }, { "Id": "", "Shipment_Job_No": "OOLU2727887140", "Container_No": "CONT2", "Container_Type": "40' HC Container DRY", "Seal_No_1": "", "Seal_No_2": "" }, { "Id": "", "Shipment_Job_No": "OOLU2727887140", "Container_No": "CONT3", "Container_Type": "40' HC Container DRY", "Seal_No_1": "", "Seal_No_2": "" }, { "Id": "", "Shipment_Job_No": "OOLU2727887140", "Container_No": "CONT4", "Container_Type": "40' HC Container DRY", "Seal_No_1": "", "Seal_No_2": "" }] }, { "Job_No": "COAU7246303240", "Master_BL_No": "COAU7246303240", "Container_Mode": "FCL", "Place_Of_Loading_ID": "IDSUB", "Place_Of_Loading_Name": "SURABAYA", "Place_Of_Discharge_ID": "MYPKG", "Place_Of_Discharge_Name": "PORT KLANG", "Vessel_Name": "CMA CGM LISBON", "Voyage_No": "1UE0PS1NC", "ETD_Date": "2023-11-05T00:00:00", "ETA_Date": "2023-11-11T00:00:00", "Carrier_Matchcode": "HELWOR", "Carrier_Name": "Hellmann Worldwide Logistics", "Carrier_Contract_No": "", "Carrier_Booking_Reference_No": "", "Inco_Terms": "FOB", "Controlling_Customer_Name": "Mondelez Malaysia Sales Sdn Bhd", "Shipper_Name": "PT. Mondelez Indonesia Manufacturing", "Consignee_Name": "Mondelez Malaysia Sales Sdn Bhd", "Total_No_Of_Pieces": 12876, "Package_Type": "CAS", "Total_No_Of_Volume_Weight_MTQ": 336.15, "Total_No_Of_Gross_Weight_KGM": 62210.97, "Description": "", "Shipment_Note": "12-7-2023_2-40-21_6.pdf", "Container_List": [{ "Id": "", "Shipment_Job_No": "COAU7246303240", "Container_No": "FFAU3182236", "Container_Type": "40' HC Container DRY", "Seal_No_1": "", "Seal_No_2": "" }, { "Id": "", "Shipment_Job_No": "COAU7246303240", "Container_No": "TCNU1076182", "Container_Type": "40' HC Container DRY", "Seal_No_1": "", "Seal_No_2": "" }, { "Id": "", "Shipment_Job_No": "COAU7246303240", "Container_No": "TRHU4316779", "Container_Type": "40' HC Container DRY", "Seal_No_1": "", "Seal_No_2": "" }, { "Id": "", "Shipment_Job_No": "COAU7246303240", "Container_No": "TRHU5360729", "Container_Type": "40' HC Container DRY", "Seal_No_1": "", "Seal_No_2": "" }, { "Id": "", "Shipment_Job_No": "COAU7246303240", "Container_No": "TRHU6643678", "Container_Type": "40' HC Container DRY", "Seal_No_1": "", "Seal_No_2": "" }] }, { "Job_No": "ONEYSUBD27131400", "Master_BL_No": "ONEYSUBD27131400", "Container_Mode": "FCL", "Place_Of_Loading_ID": "IDSUB", "Place_Of_Loading_Name": "SURABAYA", "Place_Of_Discharge_ID": "MYPKG", "Place_Of_Discharge_Name": "PORT KLANG", "Vessel_Name": "APL PUSAN", "Voyage_No": "0AU8KN", "ETD_Date": "2023-11-14T00:00:00", "ETA_Date": "2023-11-20T00:00:00", "Carrier_Matchcode": "OCENET", "Carrier_Name": "ONE", "Carrier_Contract_No": "", "Carrier_Booking_Reference_No": "", "Inco_Terms": "FCA", "Controlling_Customer_Name": "Mondelez Malaysia Sales Sdn Bhd", "Shipper_Name": "", "Consignee_Name": "", "Total_No_Of_Pieces": 0, "Package_Type": "", "Total_No_Of_Volume_Weight_MTQ": 53.84, "Total_No_Of_Gross_Weight_KGM": 6657.71, "Description": "", "Shipment_Note": "12-7-2023_2-40-21_7.pdf", "Container_List": [{ "Id": "", "Shipment_Job_No": "ONEYSUBD27131400", "Container_No": "CONT5", "Container_Type": "40' Container REEFER", "Seal_No_1": "", "Seal_No_2": "" }] }, { "Job_No": "EGLV050300887602", "Master_BL_No": "EGLV050300887602", "Container_Mode": "FCL", "Place_Of_Loading_ID": "THLCH", "Place_Of_Loading_Name": "LAEM CHABANG", "Place_Of_Discharge_ID": "MYPKG", "Place_Of_Discharge_Name": "PORT KLANG", "Vessel_Name": "EVER PEARL", "Voyage_No": "0656-393S", "ETD_Date": "2023-10-23T00:00:00", "ETA_Date": "2023-10-24T00:00:00", "Carrier_Matchcode": "EVESHI", "Carrier_Name": "Evergreen", "Carrier_Contract_No": "", "Carrier_Booking_Reference_No": "", "Inco_Terms": "", "Controlling_Customer_Name": "Mondelez Malaysia Sales Sdn Bhd", "Shipper_Name": "", "Consignee_Name": "", "Total_No_Of_Pieces": 0, "Package_Type": "", "Total_No_Of_Volume_Weight_MTQ": 65.84, "Total_No_Of_Gross_Weight_KGM": 14884.77, "Description": "", "Shipment_Note": "12-7-2023_2-40-21_8.pdf", "Container_List": [{ "Id": "", "Shipment_Job_No": "EGLV050300887602", "Container_No": "EMCU8850477", "Container_Type": "40' HC Container DRY", "Seal_No_1": "", "Seal_No_2": "" }] }, { "Job_No": "COAU7246221480", "Master_BL_No": "COAU7246221480", "Container_Mode": "FCL", "Place_Of_Loading_ID": "THLCH", "Place_Of_Loading_Name": "LAEM CHABANG", "Place_Of_Discharge_ID": "MYPKG", "Place_Of_Discharge_Name": "PORT KLANG", "Vessel_Name": "X-PRESS AQUARIUS", "Voyage_No": "015W", "ETD_Date": "2023-11-18T00:00:00", "ETA_Date": "2023-11-23T00:00:00", "Carrier_Matchcode": "HELWOR", "Carrier_Name": "Hellmann Worldwide Logistics", "Carrier_Contract_No": "", "Carrier_Booking_Reference_No": "", "Inco_Terms": "FCA", "Controlling_Customer_Name": "Mondelez Malaysia Sales Sdn Bhd", "Shipper_Name": "Mondelez International (Thailand) Co., Ltd.", "Consignee_Name": "Cadbury Confectionery Sales (M) Sdn Bhd", "Total_No_Of_Pieces": 5553, "Package_Type": "CAS", "Total_No_Of_Volume_Weight_MTQ": 80.672, "Total_No_Of_Gross_Weight_KGM": 47705.72, "Description": "", "Shipment_Note": "12-7-2023_2-40-21_9.pdf", "Container_List": [{ "Id": "", "Shipment_Job_No": "COAU7246221480", "Container_No": "FFAU2957695", "Container_Type": "40' HC Container DRY", "Seal_No_1": "", "Seal_No_2": "" }, { "Id": "", "Shipment_Job_No": "COAU7246221480", "Container_No": "TRHU4200650", "Container_Type": "40' HC Container DRY", "Seal_No_1": "", "Seal_No_2": "" }] }]

var shipments = JSON.parse(shipments_list);
var existingShipments = [];

// Begin transaction
snowflake.execute({ sqlText: "begin" });

try {
    for (var i = 0; i < shipments.length; i++) {
        var shipment = shipments[i];

        // Check if shipment already exists
        var checkSql = `SELECT COUNT(*) AS count FROM shipments WHERE Job_No = ${shipment.Job_No}`;
        var result = snowflake.execute({ sqlText: checkSql });
        result.next();

        if (result.getColumnValue(1) > 0) {
            existingShipments.push(shipment.Job_No);
            continue;
        }

        for (var j = 0; j < shipment.Container_List.length; j++) {
            var container = shipment.Container_List[j];
            var containerSql = `CALL CREATE_CONTAINER ('${container.Shipment_Job_No}', '${container.Container_No}', '${container.Container_Type}', '${container.Seal_No_1}', '${container.Seal_No_2}')`;
            snowflake.execute({ sqlText: containerSql });
        }

        // Insert shipment
        var callSql = `CALL CREATE_SHIPMENT ('${shipment.Job_No}', '${shipment.Master_BL_No}', '${shipment.Container_Mode}', '${shipment.Place_Of_Loading_ID}', '${shipment.Place_Of_Loading_Name}', '${shipment.Place_Of_Discharge_ID}', '${shipment.Place_Of_Discharge_Name}', '${shipment.Vessel_Name}', '${shipment.Voyage_No}', '${shipment.ETD_Date}', '${shipment.ETA_Date}', '${shipment.Carrier_Matchcode}', '${shipment.Carrier_Name}', '${shipment.Carrier_Contract_No}', '${shipment.Carrier_Booking_Reference_No}', '${shipment.Inco_Terms}', '${shipment.Controlling_Customer_Name}', '${shipment.Shipper_Name}', '${shipment.Consignee_Name}', '${shipment.Total_No_Of_Pieces}', '${shipment.Package_Type}', '${shipment.Total_No_Of_Volume_Weight_MTQ}', '${shipment.Total_No_Of_Gross_Weight_KGM}', '${shipment.Description}', '${shipment.Shipment_Note}')`;

        snowflake.execute({ sqlText: callSql });
    }

    if (existingShipments.length > 0) {
        // If there are existing shipments, rollback and return their job numbers
        snowflake.execute({ sqlText: "rollback" });
        return JSON.stringify({ "existingShipments": existingShipments });
    } else {
        // Commit if all insertions are successful
        snowflake.execute({ sqlText: "commit" });
        return JSON.stringify({ "success": true });
    }
} catch (err) {
    // Rollback in case of any other error
    snowflake.execute({ sqlText: "rollback" });
    return JSON.stringify({ "error": err.message });
}